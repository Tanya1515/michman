---

- name: Install Slurm REST-API packages
  become: yes
  package:
    name: slurmrestd
    state: latest

- name: Install slurmrestd.conf
  become: true 
  template:
    src: "templates/slurm/slurmrestd.conf.j2"
    dest: "{{ SLURM_CONFIG_DIR }}/slurmrestd.conf"
    owner: root
    group: root
    mode: 0444

- name: Change unit file for slurmrestd
  become: true
  lineinfile: 
    path: /lib/systemd/system/slurmrestd.service
    state: absent
    regexp: '^ExecStart=/usr/sbin'

- name: Ð¡onfiguration for TCP/IP socket
  become: true
  lineinfile: 
    backrefs: yes
    path: /lib/systemd/system/slurmrestd.service
    regexp: "{{ item.line }}"
    line: "{{ item.change }}"
  loop:
    - { line: '^#ExecStart=/usr/sbin/', change: ExecStart=/usr/sbin/slurmrestd $SLURMRESTD_OPTIONS 0.0.0.0:6820 }
    - { line: '^#Environment="SLURM_JWT=daemon"', change: Environment="SLURM_JWT=daemon" }
  notify:
    - reload slurmrestd
    - restart slurmrestd
    
- name: Reload systemd
  become: true 
  systemd:
    daemon_reload: yes
    
- name: Export envs for configurating slurmrestd
  become: yes
  lineinfile:
     path: /etc/environment
     line: "{{item}}"
  loop:
     - export SLURMRESTD_AUTH_TYPES=rest_auth/jwt 

- name: Source envs
  shell: 
    . /etc/environment
