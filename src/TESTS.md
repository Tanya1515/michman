# Тесты

## Написание
Для написания теста необходимо, чтобы все структуры, которые использует тестируемый метод, являлись полем тестируемой структуры типа интерфейс. Таким образом, существует возможность при создании экземпляра структуры передавать ей на вход конкретные реализации интерфейса(конкретные структуры), что позволяет при тестировании передавать заглушки или **mock**-и. Делается это с целью отбрасывания сторонних зависимостей при модульном тестировании.
(Подход "интерфейс в качестве поля, а не конкретная структура" также наблюдался в большом количестве проектов на гитхабе).

## Используемые инструменты
Используется стандартная библиотека test. Для создания **mock**-ов существует библиотека **mockgen**. По её использованию есть [исчерпывающий гайд](https://blog.codecentric.de/en/2017/08/gomock-tutorial/). Основное оттуда.

### Установка
```
go get github.com/golang/mock/gomock
go get github.com/golang/mock/mockgen
```

### Создание заглушки
```
mockgen -destination=path/to/dest/file -package=mocks github.com/.../ InterfaceName
```
Где:
* **-destination** - файл, куда запишется сгенерированный **mock**
* **-package** - имя пакета. Рекомендуется хранить все **mock** файлы в одной директории с одним и тем же именем пакета
* **github.com/.../** - путь до файла, в котором находится интерфейс
* **InterfaceName** - имя целевого интерфейса

## Процесс написания
Примеры тестов находятся в src/handlers/cluster_test.go и src/handlers/project_test.go. Другие тестовые файлы на данный момент не переписаны(в части, вроде, до сих пор не используется gomock). Собственно, тестирование только данных файлов и запускается на данный момент с помощью CI.

### По использованию go test и не только
* Тестовый файл должен оканчиваться на **_test.go**
* Функция тестирования должна начинаться на **Test...**, и принимать единственный аргумент в виде указателя на специальную структуру **testing.T**

### По использованию mock объектов в тесте
Для создания **mock** структуры необходимо сначала создать контроллер:
```
mockCtrl := gomock.NewController(t) # t - специальная структура языка go для тестирования
```
Далее, используя созданный контроллер:
```
mockStruct := mocks.NewMockInterfaceName(mockCtrl)
```
Метод **NewMock...** генерируется mockgen.
Кроме, собственно, заглушки, **mock** предоставляют механизмы, позволяющие проверять, какая функция была вызвана внутри тестируемого метода и с какими аргументам. Также можно задавать возвращаемое значение данного метода, что позволяет полностью имитировать поведение сторонней зависимости, определяя дальнейший ход выполнения тестируемого метода. Пример:
```
mockDatabase.EXPECT().ReadProject(projectName).Return(&protobuf.Project{ID: "test-TEST-UUID-123", Name: "NotEmptyName"}, nil)```
