---
- name: Log into registry
  docker_login:
    registry: "{{ nextcloud_registry }}"
    username: "{{ nextcloud_registry_user }}"
    password: "{{ nextcloud_registry_user_password }}"

- name: Create mariadb container
  docker_container:
    name: "mariadb"
    image: "{{ mariadb_image }}"
    env:
      MARIADB_ROOT_PASSWORD: rootpassword
      MARIADB_DATABASE: nextcloud
      MARIADB_USER: nc_user
      MARIADB_PASSWORD: nc_password
    restart_policy: always

- name: Wait for mariadb startup
  command:  docker exec mariadb sh -c 'mysqladmin ping'
  register: result
  until: not result.rc
  retries: 60
  delay: 2

- name: Create nextcloud container
  docker_container:
    name: "nextcloud"
    image: "{{ nextcloud_image }}"
#    restart: yes
    env:
      MYSQL_HOST: mariadb
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nc_user
      MYSQL_PASSWORD: nc_password
      NEXTCLOUD_ADMIN_USER: admin
      NEXTCLOUD_ADMIN_PASSWORD: password
      NEXTCLOUD_TRUSTED_DOMAINS: '{{ ansible_host }} {{ nextcloud_url.split("/")[0] }}'
    links:
      - "mariadb:mariadb"
    ports:
      - "80:80"
      - "2022:22"
    restart_policy: always
    volumes:
      - /home:/external_data
      - /root/.ssh/authorized_keys:/root/.ssh/authorized_keys
    etc_hosts: >
      {
        "{{ custom_oidc_providers_host }}" : "{{ custom_oidc_providers_ip }}"
      }


- name: Wait for nextcloud setup
  command: curl {{ ansible_host }}:80
  register: result
  until: not result.rc
  retries: 60
  delay: 2

- name: configure nextcloud url
  shell: "docker exec -u www-data nextcloud php occ config:system:set {{ item.key }} --value {{ item.value }}"
  with_items: "{{ nc_url_config }}"

- name: configure nextcloud apps
  shell: "docker exec -u www-data nextcloud php occ app:{{ item.key }} {{ item.value }}"
  with_items: "{{ nc_app_config }}"
  ignore_errors: true

- name: remove default nextcloud files
  shell: "docker exec -u www-data nextcloud bash -c 'rm -rf core/skeleton/*'"

- name: add nextcloud users group
  shell: "docker exec -u www-data nextcloud php occ group:add {{ nextcloud_users_group }}"
  ignore_errors: true

- name: configure nextcloud social login to use keycloak (OpenID)
  shell: "docker exec -u www-data nextcloud php occ config:app:set files_external \"user_mounting_backends\" --value \"{{ nextcloud_user_mounting_backends_list }}\""

- name: configure nextcloud external storage app
  shell: "docker exec -u www-data nextcloud php occ config:app:set sociallogin \"custom_oidc_providers\" --value \"[ {{ custom_oidc_providers }} ]\""

- name: create group directory
  shell: "docker exec nextcloud mkdir -p {{ nextcloud_group_dir }}"

- name: change group directory permissions
  shell: "docker exec nextcloud chown -R www-data {{ nextcloud_group_dir }}"

- name: configure external storage for group
  shell: "docker exec -u www-data nextcloud php occ files_external:create {{ weblab_name }} local null::null -n --config datadir={{ nextcloud_group_dir }}"

- name: update apt cache in nextcloud container
  shell: "docker exec nextcloud apt update"

- name: install sshd in nextcloud container
  shell: "docker exec nextcloud apt install -y ssh"

- name: start sshd in nextcloud container
  shell: "docker exec nextcloud service ssh start"
